# Lection 9
==========================================================

## Введение в БД

### Расширенные возможности SQL. Триггеры
------------------

Триггеры являются одной из специальных разновидностей хранимых процедур. Их исполнение происходит при выполнении для таблицы какого-либо оператора языка манипулирования данными (DML). Триггеры используются для проверки целостности данных, для заполнения
значений по умолчанию, а также для отката транзакций в случае нарушения каких-либо правил
целостности.

Триггер запускается сервером автоматически при попытке изменения данных в таблицах, с
которыми триггеры связаны. Каждый триггер привязывается к конкретной таблице. Все
производимые им модификации данных рассматриваются как одна транзакция. В случае
обнаружения ошибки или нарушения целостности данных происходит откат этой транзакции. Тем
самым внесение изменений запрещается. Отменяются также все изменения, уже сделанные
триггером.

Создает триггер только владелец базы данных. Это ограничение позволяет избежать случайного
изменения структуры таблиц, способов связи с ними других объектов и т.п.

> CREATE TRIGGER имя_триггера
 BEFORE | AFTER <триггерное_событие>
 ON <имя_таблицы>
 [REFERENCING
<список_старых_или_новых_псевдонимов>]
[FOR EACH { ROW | STATEMENT}]
 [WHEN(условие_триггера)]
<тело_триггера>

триггерные события состоят из вставки, удаления и обновления строк в таблице. В последнем
случае для триггерного события можно указать конкретные имена столбцов таблицы. Время
запуска триггера определяется с помощью ключевых слов BEFORE (триггер запускается до
выполнения связанных с ним событий) или AFTER (после их выполнения).

Выполняемые триггером действия задаются для каждой строки ( FOR EACH ROW ), охваченной
данным событием, или только один раз для каждого события ( FOR EACH STATEMENT ).
Существует параметр, определяющий поведение триггеров:
* AFTER. Триггер выполняется после успешного выполнения вызвавших его команд. Если
же команды по какой-либо причине не могут быть успешно завершены, триггер не
выполняется. Можно определить несколько AFTER -триггеров для каждой операции (
INSERT, UPDATE, DELETE ).



<u>Триггеры различают по типу команд, на которые они реагируют:</u>
* INSERT TRIGGER – запускаются при попытке вставки данных с помощью команды
INSERT.
* UPDATE TRIGGER – запускаются при попытке изменения данных с помощью команды
UPDATE.
* DELETE TRIGGER – запускаются при попытке удаления данных с помощью команды
DELETE.

Отметим, что внутри триггера не допускается выполнение ряда операций, таких, например, как:
* создание, изменение и удаление базы данных;

* восстановление резервной копии базы данных или журнала транзакций.

При выполнении команд добавления, изменения и удаления записей PostgreSQL создает две
специальные таблицы:  old и new. В них
содержатся списки строк, которые будут вставлены или удалены по завершении транзакции.

Структура таблиц old и new идентична структуре таблиц, для которой определяется
триггер. Для каждого триггера создается свой комплект таблиц old и new, поэтому никакой
другой триггер не сможет получить к ним доступ. В зависимости от типа операции, вызвавшей
выполнение триггера, содержимое таблиц может быть разным:

* команда INSERT работает только с таблицей new.

* команда DELETE – только с таблицей old.

* команда UPDATE – с обеими таблицами.

В PostgreSQL триггер выполняется как неявно определенная транзакция, поэтому внутри
триггера допускается применение команд управления транзакциями. В частности, при
обнаружении нарушения ограничений целостности для прерывания выполнения триггера и
отмены всех изменений, которые пытался выполнить пользователь, необходимо использовать
команду ROLLBACK TRANSACTION.

<u>Для удаления триггера используется команда:</u>
> DROP TRIGGER {имя_триггера} [,...n]
